# 家族承認システムの実装

## 概要

介護施設アプリケーションに、スタッフが入居者と家族情報を一括登録し、家族がアプリに登録する際の承認システムを実装しました。これにより、データの整合性を保ちながら、現実的な運用フローを実現しています。

## 変更の背景・理由

### 問題点
従来のシステムでは以下の問題がありました：

1. **データ整合性の問題**
   - 家族ユーザー: 新規登録時に「入居者を選択」→ 家族ID ↔ 入居者ID の紐づけが完了
   - スタッフ: 入居者管理画面で「入居者を追加」→ 家族との紐づけなしで入居者が作成される

2. **ビジネスロジックの矛盾**
   ```
   家族の登録フロー: 家族 → 入居者選択 → 紐づけ完了
   スタッフの登録フロー: スタッフ → 入居者作成 → 家族との紐づけなし
   ```

3. **実際の運用での問題**
   - スタッフが作成した入居者に家族が紐づけられない
   - 家族が登録しようとした入居者が既にスタッフによって作成されている可能性
   - メッセージ機能で「家族が見つからない」エラーが発生する根本原因

### 解決策
**家族主導の登録フロー**を採用し、以下の流れを実現：

1. **スタッフによる一括登録**: 入居者情報と家族情報を同時に登録
2. **家族の照合登録**: 名前による照合でアプリに登録
3. **承認制の導入**: セキュリティとデータ整合性を確保

## 実装内容

### 1. データベーススキーマの更新

#### UserテーブルにisApprovedカラムを追加
```sql
ALTER TABLE User ADD COLUMN isApproved BOOLEAN DEFAULT FALSE;
```

**目的**: 家族ユーザーの承認状態を管理
- `false`: 未承認（スタッフが登録したが、家族がまだアプリに登録していない）
- `true`: 承認済み（家族がアプリに登録完了）

### 2. 入居者追加フォームの拡張

#### 追加された入力フィールド
- **家族名** (必須)
- **メールアドレス** (必須)
- **電話番号** (任意)
- **続柄** (選択式: 配偶者、子、親、兄弟姉妹、孫、その他)

#### バリデーション
```typescript
if (!newResident.familyName.trim()) {
  toast.error('家族名を入力してください');
  return;
}

if (!newResident.familyEmail.trim()) {
  toast.error('家族のメールアドレスを入力してください');
  return;
}
```

### 3. 入居者・家族情報の一括作成

#### APIエンドポイント: `POST /api/residents`
```typescript
// トランザクションで入居者と家族情報を同時に作成
const result = await prisma.$transaction(async (tx) => {
  // 入居者を作成
  const resident = await tx.resident.create({
    data: {
      name,
      birthday: new Date(birthday),
    },
  });

  // 家族ユーザーを作成（未承認状態）
  const familyUser = await tx.user.create({
    data: {
      name: familyName,
      email: familyEmail,
      role: "FAMILY",
      isApproved: false, // 未承認状態
    },
  });

  // 入居者と家族の紐づけを作成
  await tx.residentFamily.create({
    data: {
      residentId: resident.id,
      userId: familyUser.id,
    },
  });

  return { resident, familyUser };
});
```

**作成されるデータ**:
- `Resident`テーブル: 入居者情報
- `User`テーブル: 家族情報（`isApproved: false`）
- `ResidentFamily`テーブル: 紐づけ情報

### 4. 家族新規登録時の照合ロジック

#### APIエンドポイント: `POST /api/auth/register`
```typescript
// 名前と入居者名による照合
const existingFamily = await prisma.user.findFirst({
  where: {
    name: name,
    role: "FAMILY",
    isApproved: false, // 未承認の家族ユーザーのみ
  },
  include: {
    residentFamily: {
      include: {
        resident: true,
      },
    },
  },
});

// 入居者名の照合
const matchingResident = existingFamily.residentFamily.find(
  (rf) => rf.resident.name === residentName
);
```

**照合プロセス**:
1. 家族名で未承認の家族ユーザーを検索
2. 指定された入居者名との一致確認
3. 照合成功時: `isApproved: true`に更新
4. 照合失敗時: エラーメッセージ表示

### 5. 承認状態の管理機能

#### FamilyApprovalManagementコンポーネント
- 未承認家族の一覧表示
- 承認/拒否の操作
- 統計情報の表示

#### APIエンドポイント
- `GET /api/families/pending`: 未承認家族の一覧取得
- `POST /api/families/[id]/approve`: 家族ユーザーの承認
- `POST /api/families/[id]/reject`: 家族ユーザーの拒否・削除

## 新しい運用フロー

### 1. スタッフによる入居者・家族情報の登録

```
1. スタッフが入居者管理画面で「入居者を追加」をクリック
2. 入居者情報を入力:
   - 氏名
   - 生年月日
3. 家族情報を入力:
   - 家族名 (必須)
   - メールアドレス (必須)
   - 電話番号 (任意)
   - 続柄 (選択式)
4. 「追加」ボタンをクリック
5. データベースに以下が作成される:
   - 入居者レコード
   - 家族ユーザーレコード（未承認状態）
   - 紐づけレコード
```

### 2. 家族の新規登録

```
1. 家族がアプリの新規登録画面にアクセス
2. 以下の情報を入力:
   - 家族名
   - メールアドレス
   - パスワード
   - 入居者名
3. 「登録」ボタンをクリック
4. システムが以下を実行:
   - 家族名で未承認の家族ユーザーを検索
   - 指定された入居者名との一致確認
   - 照合成功: 承認状態を「承認済み」に更新
   - 照合失敗: エラーメッセージ表示
5. 登録完了後、ログイン可能
```

### 3. スタッフによる承認管理

```
1. スタッフが家族承認管理画面にアクセス
2. 未承認家族の一覧を確認:
   - 家族名
   - メールアドレス
   - 関連入居者名
   - 登録日
3. 各家族に対して以下を実行:
   - 「承認」ボタン: 家族ユーザーを承認済みに更新
   - 「拒否」ボタン: 家族ユーザーと関連データを削除
```

## 技術的な実装詳細

### ファイル構成

#### フロントエンド
- `src/components/ResidentManagement.tsx`: 入居者追加フォームの拡張
- `src/components/FamilyApprovalManagement.tsx`: 承認管理画面

#### バックエンド
- `src/app/api/residents/route.ts`: 入居者・家族情報の一括作成
- `src/app/api/auth/register/route.ts`: 家族新規登録時の照合
- `src/app/api/families/pending/route.ts`: 未承認家族の一覧取得
- `src/app/api/families/[id]/approve/route.ts`: 家族ユーザーの承認
- `src/app/api/families/[id]/reject/route.ts`: 家族ユーザーの拒否・削除

#### データベース
- `prisma/schema.prisma`: UserテーブルにisApprovedカラム追加

### セキュリティ対策

1. **認証チェック**: すべてのAPIエンドポイントでセッション認証を実施
2. **権限チェック**: スタッフのみが入居者追加・承認操作を実行可能
3. **データ整合性**: トランザクション処理によりデータの一貫性を保証
4. **入力検証**: 必須項目のバリデーションとエラーハンドリング

## 利点

### 1. データ整合性
- 入居者と家族の紐づけが確実に完了
- メッセージ機能が正常に動作
- データの不整合によるエラーを防止

### 2. 運用の現実性
- 紙ベースの情報収集 → デジタル化の流れが自然
- スタッフの業務フローに合致
- 実際の介護施設の運用に適している

### 3. セキュリティ
- 承認制により不正な登録を防止
- スタッフによる事前審査
- 家族情報の適切な管理

### 4. ユーザビリティ
- 家族は照合のみで登録完了
- 複雑な入居者選択が不要
- 直感的な操作フロー

## 今後の拡張可能性

1. **通知機能**: 家族登録申請時のスタッフへの通知
2. **承認履歴**: 承認・拒否の履歴管理
3. **一括承認**: 複数の家族を一括で承認
4. **承認期限**: 一定期間後の自動拒否機能
5. **家族情報の更新**: 承認後の家族情報変更機能

## まとめ

この実装により、介護施設アプリケーションのデータ整合性が大幅に改善され、現実的な運用フローが実現されました。スタッフが入居者と家族情報を一括で登録し、家族がアプリに登録する際は名前による照合で承認される仕組みにより、安全で効率的な家族管理システムが構築されています。
